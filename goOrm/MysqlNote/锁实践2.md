# 锁实践

## 表设计
```BASH
+--------------+------+------+-----+---------+----------------+
| Field       | Type | Null | Key | Default | Extra           |
+--------------+------+------+-----+---------+----------------+
| id           | int  | NO   | PRI | NULL    | auto_increment |
| unique_index | int  | NO   | UNI | NULL    |                |
| normal_index | int  | NO   | MUL | NULL    |                |
| normal       | int  | NO   |     | NULL    |                |
+--------------+------+------+-----+---------+----------------+
```
```BASH
+----+--------------+--------------+--------+
| id | unique_index | normal_index | normal |
+----+--------------+--------------+--------+
|  0 |            0 |            0 |      0 |
|  5 |            5 |            5 |      5 |
| 10 |           10 |           10 |     10 |
| 15 |           15 |           15 |     15 |
+----+--------------+--------------+--------+
```

## 主键查询
### 等值查询,数据存在
对主键加记录锁
```SQL
select * from key_demo where id=5 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 140285431475416:2163:140285443101392     |                 35971 |        50 |       94 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL       |       140285443101392 | TABLE     | IX            | GRANTED     | NULL      |
| INNODB | 140285431475416:1098:4:2:140285443098400 |                 35971 |        50 |       94 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X,REC_NOT_GAP | GRANTED     | 5         |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+-----------+
```
### 等值查询,数据不存在
对下一条记录加间隙锁(就是对间隙加锁)
```SQL
select * from key_demo where id=6 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
| INNODB | 140285431475416:2163:140285443101392     |                 35972 |        50 |       98 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL       |       140285443101392 | TABLE     | IX        | GRANTED     | NULL      |
| INNODB | 140285431475416:1098:4:4:140285443098400 |                 35972 |        50 |       98 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X,GAP     | GRANTED     | 10        |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
```
### 范围查询,数据不存在
对下条记录的主键加间隙锁
```SQL
select * from key_demo where id>7 and id<9 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
| INNODB | 140285431475416:2163:140285443101392     |                 35973 |        50 |      103 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL       |       140285443101392 | TABLE     | IX        | GRANTED     | NULL      |
| INNODB | 140285431475416:1098:4:4:140285443098400 |                 35973 |        50 |      103 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X,GAP     | GRANTED     | 10        |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
```
特殊:
如果查询范围超过最大值,会对supremum pseudo-record加临键锁,因为针对supremum pseudo-record加锁只会加临键锁,不会加间隙锁
```SQL
select * from key_demo where id>20 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA              |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
| INNODB | 140285431475416:2163:140285443101392     |                 35974 |        50 |      107 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL       |       140285443101392 | TABLE     | IX        | GRANTED     | NULL                   |
| INNODB | 140285431475416:1098:4:1:140285443098400 |                 35974 |        50 |      107 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | supremum pseudo-record |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
```

### 范围查询,数据存在
由于查询的结果是>5,并不包含5,因此不会对5加临键锁(0,5],而是加
10的临键锁为 (5,10]
15的临键锁为 (10,15]
需要注意的是:

如果查询范围包含了/超过 最大值,则会对supremum pseudo-record加临键锁
```SQL
select * from key_demo where id>5 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA              |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
| INNODB | 140285431475416:2163:140285443101392     |                 35975 |        50 |      111 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL       |       140285443101392 | TABLE     | IX        | GRANTED     | NULL                   |
| INNODB | 140285431475416:1098:4:1:140285443098400 |                 35975 |        50 |      111 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | supremum pseudo-record |
| INNODB | 140285431475416:1098:4:4:140285443098400 |                 35975 |        50 |      111 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | 10                     |
| INNODB | 140285431475416:1098:4:5:140285443098400 |                 35975 |        50 |      111 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | 15                     |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
```


由于查询的结果是>=5,并不包含<5,因此对5加记录锁,对后面的存在的记录加临键锁
10的临键锁为 (5,10]
15的临键锁为 (10,15]
由于查询范围包含了最大值,因此对supremum pseudo-record加临键锁
```SQL
select * from key_demo where id>=5 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA              |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
| INNODB | 140285431475416:2163:140285443101392     |                 35976 |        50 |      115 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL       |       140285443101392 | TABLE     | IX            | GRANTED     | NULL                   |
| INNODB | 140285431475416:1098:4:2:140285443098400 |                 35976 |        50 |      115 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X,REC_NOT_GAP | GRANTED     | 5                      |
| INNODB | 140285431475416:1098:4:1:140285443098744 |                 35976 |        50 |      115 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098744 | RECORD    | X             | GRANTED     | supremum pseudo-record |
| INNODB | 140285431475416:1098:4:4:140285443098744 |                 35976 |        50 |      115 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098744 | RECORD    | X             | GRANTED     | 10                     |
| INNODB | 140285431475416:1098:4:5:140285443098744 |                 35976 |        50 |      115 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098744 | RECORD    | X             | GRANTED     | 15                     |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+---------------+-------------+------------------------+
```


```SQL
select * from key_demo where  id <10 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
| INNODB | 140046389701848:2163:140046401327824     |                 36385 |        49 |       96 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL       |       140046401327824 | TABLE     | IX        | GRANTED     | NULL      |
| INNODB | 140046389701848:1098:4:2:140046401324832 |                 36385 |        49 |       96 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140046401324832 | RECORD    | X         | GRANTED     | 5         |
| INNODB | 140046389701848:1098:4:3:140046401324832 |                 36385 |        49 |       96 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140046401324832 | RECORD    | X         | GRANTED     | 0         |
| INNODB | 140046389701848:1098:4:4:140046401325176 |                 36385 |        49 |       96 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140046401325176 | RECORD    | X,GAP     | GRANTED     | 10        |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
```
```SQL
select * from key_demo where  id <=10 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
| INNODB | 140285431475416:2163:140285443101392     |                 35999 |        59 |       35 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL       |       140285443101392 | TABLE     | IX        | GRANTED     | NULL      |
| INNODB | 140285431475416:1098:4:2:140285443098400 |                 35999 |        59 |       35 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | 5         |
| INNODB | 140285431475416:1098:4:3:140285443098400 |                 35999 |        59 |       35 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | 0         |
| INNODB | 140285431475416:1098:4:4:140285443098400 |                 35999 |        59 |       35 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | 10        |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
```
### 综合
```SQL
select * from key_demo where id <=15 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA              |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
| INNODB | 140285431475416:2163:140285443101392     |                 36000 |        59 |       39 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL       |       140285443101392 | TABLE     | IX        | GRANTED     | NULL                   |
| INNODB | 140285431475416:1098:4:1:140285443098400 |                 36000 |        59 |       39 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | supremum pseudo-record |
| INNODB | 140285431475416:1098:4:2:140285443098400 |                 36000 |        59 |       39 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | 5                      |
| INNODB | 140285431475416:1098:4:3:140285443098400 |                 36000 |        59 |       39 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | 0                      |
| INNODB | 140285431475416:1098:4:4:140285443098400 |                 36000 |        59 |       39 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | 10                     |
| INNODB | 140285431475416:1098:4:5:140285443098400 |                 36000 |        59 |       39 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | 15                     |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
```
```SQL
select * from key_demo where id<15 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
| INNODB | 140285431475416:2163:140285443101392     |                 36001 |        59 |       43 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL       |       140285443101392 | TABLE     | IX        | GRANTED     | NULL      |
| INNODB | 140285431475416:1098:4:2:140285443098400 |                 36001 |        59 |       43 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | 5         |
| INNODB | 140285431475416:1098:4:3:140285443098400 |                 36001 |        59 |       43 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | 0         |
| INNODB | 140285431475416:1098:4:4:140285443098400 |                 36001 |        59 |       43 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098400 | RECORD    | X         | GRANTED     | 10        |
| INNODB | 140285431475416:1098:4:5:140285443098744 |                 36001 |        59 |       43 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140285443098744 | RECORD    | X,GAP     | GRANTED     | 15        |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+-----------+
```
## 唯一索引
需要区别for update 和 for share
### 等值查询,数据存在
写锁会对主键以及唯一索引都加记录锁(不论需不需要回表查询)
```SQL
select * from key_demo where unique_index=5 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 140285431475416:2163:140285443101392     |                 35978 |        50 |      125 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL         |       140285443101392 | TABLE     | IX            | GRANTED     | NULL      |
| INNODB | 140285431475416:1098:5:2:140285443098400 |                 35978 |        50 |      125 | mysql_lock_demo | key_demo    | NULL           | NULL              | unique_index |       140285443098400 | RECORD    | X,REC_NOT_GAP | GRANTED     | 5, 5      |
| INNODB | 140285431475416:1098:4:2:140285443098744 |                 35978 |        50 |      125 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY      |       140285443098744 | RECORD    | X,REC_NOT_GAP | GRANTED     | 5         |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
```
读锁且查询数据不需要回表查询,只会对唯一索引加记录锁

```SQL
select unique_index from key_demo where unique_index=5 for share;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 140285431475416:2163:140285443101392     |       421760408186072 |        50 |      134 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL         |       140285443101392 | TABLE     | IS            | GRANTED     | NULL      |
| INNODB | 140285431475416:1098:5:2:140285443098400 |       421760408186072 |        50 |      134 | mysql_lock_demo | key_demo    | NULL           | NULL              | unique_index |       140285443098400 | RECORD    | S,REC_NOT_GAP | GRANTED     | 5, 5      |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
```

### 等值查询,数据不存在
对下一条数据加间隙锁,如果下一条数据是 supremum pseudo-recor,则为临键锁
```SQL
select unique_index from key_demo where unique_index=6 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+-----------+
| INNODB | 140285431475416:2163:140285443101392     |                 35980 |        50 |      143 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL         |       140285443101392 | TABLE     | IX        | GRANTED     | NULL      |
| INNODB | 140285431475416:1098:5:4:140285443098400 |                 35980 |        50 |      143 | mysql_lock_demo | key_demo    | NULL           | NULL              | unique_index |       140285443098400 | RECORD    | X,GAP     | GRANTED     | 10, 10    |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+-----------+
```
### 范围查询,数据不存在
主键对下一条记录加临键锁
唯一索引对下一条记录加间隙锁
```SQL
select unique_index from key_demo where unique_index<9 and unique_index>7 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 140285431475416:2163:140285443101392     |                 35982 |        50 |      152 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL         |       140285443101392 | TABLE     | IX            | GRANTED     | NULL      |
| INNODB | 140285431475416:1098:5:4:140285443098400 |                 35982 |        50 |      152 | mysql_lock_demo | key_demo    | NULL           | NULL              | unique_index |       140285443098400 | RECORD    | X             | GRANTED     | 10, 10    |
| INNODB | 140285431475416:1098:4:4:140285443098744 |                 35982 |        50 |      152 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY      |       140285443098744 | RECORD    | X,REC_NOT_GAP | GRANTED     | 10        |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
```
### 范围查询,数据存在
查询到的结果会对唯一索引会加临键锁(原理同根据主键范围查询)

不论查询数据是否需要回表查询,对查询到的数据的主键加记录锁
```SQL
select * from key_demo where unique_index>10 for share;
select unique_index from key_demo where unique_index>10 for share;
```
其中的DATA_LOCKS 15,15表示加锁的索引字段unique_index值为15,该记录对应的主键的值是15
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA              |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+------------------------+
| INNODB | 140285431475416:2163:140285443101392     |                 35987 |        50 |      169 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL         |       140285443101392 | TABLE     | IX            | GRANTED     | NULL                   |
| INNODB | 140285431475416:1098:5:1:140285443098400 |                 35987 |        50 |      169 | mysql_lock_demo | key_demo    | NULL           | NULL              | unique_index |       140285443098400 | RECORD    | X             | GRANTED     | supremum pseudo-record |
| INNODB | 140285431475416:1098:5:5:140285443098400 |                 35987 |        50 |      169 | mysql_lock_demo | key_demo    | NULL           | NULL              | unique_index |       140285443098400 | RECORD    | X             | GRANTED     | 15, 15                 |
| INNODB | 140285431475416:1098:4:5:140285443098744 |                 35987 |        50 |      169 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY      |       140285443098744 | RECORD    | X,REC_NOT_GAP | GRANTED     | 15                     |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+------------------------+
```

主键查询包含的结果加记录锁
唯一索引查询结果加临键锁

查询范围是>=10,包含10,但是不包含小于10的范围,同主键查询不同的是

    根据主键查询时候不会对id=10加临键锁,即不会锁定(5,10]的范围,
    根据唯一索引查询时候则会包含(5,10]范围

```SQL
select * from key_demo where unique_index>=10 for share;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA              |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+------------------------+
| INNODB | 140285431475416:2163:140285443101392     |       421760408186072 |        50 |      178 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL         |       140285443101392 | TABLE     | IS            | GRANTED     | NULL                   |
| INNODB | 140285431475416:1098:5:1:140285443098400 |       421760408186072 |        50 |      178 | mysql_lock_demo | key_demo    | NULL           | NULL              | unique_index |       140285443098400 | RECORD    | S             | GRANTED     | supremum pseudo-record |
| INNODB | 140285431475416:1098:5:4:140285443098400 |       421760408186072 |        50 |      178 | mysql_lock_demo | key_demo    | NULL           | NULL              | unique_index |       140285443098400 | RECORD    | S             | GRANTED     | 10, 10                 |
| INNODB | 140285431475416:1098:5:5:140285443098400 |       421760408186072 |        50 |      178 | mysql_lock_demo | key_demo    | NULL           | NULL              | unique_index |       140285443098400 | RECORD    | S             | GRANTED     | 15, 15                 |
| INNODB | 140285431475416:1098:4:4:140285443098744 |       421760408186072 |        50 |      178 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY      |       140285443098744 | RECORD    | S,REC_NOT_GAP | GRANTED     | 10                     |
| INNODB | 140285431475416:1098:4:5:140285443098744 |       421760408186072 |        50 |      178 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY      |       140285443098744 | RECORD    | S,REC_NOT_GAP | GRANTED     | 15                     |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+------------------------+
```
读锁查询记录不需要回表查询,则不会对主键加记录锁
```SQL
select unique_index from key_demo where unique_index>=10 for share;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA              |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+------------------------+
| INNODB | 140285431475416:2163:140285443101392     |       421760408186072 |        50 |      183 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL         |       140285443101392 | TABLE     | IS        | GRANTED     | NULL                   |
| INNODB | 140285431475416:1098:5:1:140285443098400 |       421760408186072 |        50 |      183 | mysql_lock_demo | key_demo    | NULL           | NULL              | unique_index |       140285443098400 | RECORD    | S         | GRANTED     | supremum pseudo-record |
| INNODB | 140285431475416:1098:5:4:140285443098400 |       421760408186072 |        50 |      183 | mysql_lock_demo | key_demo    | NULL           | NULL              | unique_index |       140285443098400 | RECORD    | S         | GRANTED     | 10, 10                 |
| INNODB | 140285431475416:1098:5:5:140285443098400 |       421760408186072 |        50 |      183 | mysql_lock_demo | key_demo    | NULL           | NULL              | unique_index |       140285443098400 | RECORD    | S         | GRANTED     | 15, 15                 |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+------------------------+
```
## 普通索引
需要区别for update 和 for share
### 等值查询,数据存在
for update

    不论查询结果是否需要回表,都会对查询出来的结果的主键加行锁
    对查询出来的结果加临键锁
    对查询出来的结果的下一个值加间隙锁(如果是supremum pseudo-recor,则不会退化为间隙锁)

```SQL
select normal_index from key_demo where normal_index=5 for update;
select * from key_demo where normal_index=5 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 140046389701848:2163:140046401327824     |                 36369 |        49 |       35 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL         |       140046401327824 | TABLE     | IX            | GRANTED     | NULL      |
| INNODB | 140046389701848:1098:6:2:140046401324832 |                 36369 |        49 |       35 | mysql_lock_demo | key_demo    | NULL           | NULL              | normal_index |       140046401324832 | RECORD    | X             | GRANTED     | 5, 5      |
| INNODB | 140046389701848:1098:4:2:140046401325176 |                 36369 |        49 |       35 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY      |       140046401325176 | RECORD    | X,REC_NOT_GAP | GRANTED     | 5         |
| INNODB | 140046389701848:1098:6:4:140046401325520 |                 36369 |        49 |       35 | mysql_lock_demo | key_demo    | NULL           | NULL              | normal_index |       140046401325520 | RECORD    | X,GAP         | GRANTED     | 10, 10    |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
```
```SQL
select normal_index from key_demo where normal_index=5 for share;
select * from key_demo where normal_index=5 for share;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+-----------+
| INNODB | 140046389701848:2163:140046401327824     |       421521366412504 |        49 |       92 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL         |       140046401327824 | TABLE     | IS        | GRANTED     | NULL      |
| INNODB | 140046389701848:1098:6:2:140046401324832 |       421521366412504 |        49 |       92 | mysql_lock_demo | key_demo    | NULL           | NULL              | normal_index |       140046401324832 | RECORD    | S         | GRANTED     | 5, 5      |
| INNODB | 140046389701848:1098:6:4:140046401325176 |       421521366412504 |        49 |       92 | mysql_lock_demo | key_demo    | NULL           | NULL              | normal_index |       140046401325176 | RECORD    | S,GAP     | GRANTED     | 10, 10    |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+-----------+
```
### 等值查询,数据不存在
for update /for share
无论查询结果是否需要回表,都会对下一条结果加间隙锁
不会对主键加锁
```SQL
select * from key_demo where normal_index=6 for update;
select normal_index from key_demo where normal_index=6 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+-----------+
| INNODB | 140046389701848:2163:140046401327824     |                 36379 |        49 |       52 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL         |       140046401327824 | TABLE     | IX        | GRANTED     | NULL      |
| INNODB | 140046389701848:1098:6:4:140046401324832 |                 36379 |        49 |       52 | mysql_lock_demo | key_demo    | NULL           | NULL              | normal_index |       140046401324832 | RECORD    | X,GAP     | GRANTED     | 10, 10    |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+-----------+
```
### 范围查询,数据不存在
for update 
    
    对下一条记录的普通索引加临键锁
    对下一条记录的主键索引加行锁
```SQL
select normal_index from key_demo where normal_index<10 and nromal_index>5 for update
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
| INNODB | 140046389701848:2163:140046401327824     |                 36384 |        49 |       75 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL         |       140046401327824 | TABLE     | IX            | GRANTED     | NULL      |
| INNODB | 140046389701848:1098:6:4:140046401324832 |                 36384 |        49 |       75 | mysql_lock_demo | key_demo    | NULL           | NULL              | normal_index |       140046401324832 | RECORD    | X             | GRANTED     | 10, 10    |
| INNODB | 140046389701848:1098:4:4:140046401325176 |                 36384 |        49 |       75 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY      |       140046401325176 | RECORD    | X,REC_NOT_GAP | GRANTED     | 10        |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+---------------+-------------+-----------+
```
for share

    对下一条记录的普通索引加临键锁
    对下一条记录的主键索引不加锁
```SQL
select normal_index from key_demo where normal_index<10 and normal_index>5 for share;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+-----------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME   | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+-----------+
| INNODB | 140046389701848:2163:140046401327824     |       421521366412504 |        49 |       80 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL         |       140046401327824 | TABLE     | IS        | GRANTED     | NULL      |
| INNODB | 140046389701848:1098:6:4:140046401324832 |       421521366412504 |        49 |       80 | mysql_lock_demo | key_demo    | NULL           | NULL              | normal_index |       140046401324832 | RECORD    | S         | GRANTED     | 10, 10    |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+--------------+-----------------------+-----------+-----------+-------------+-----------+
```
### 范围查询,数据存在
## 无索引
对全表数据加锁,且锁是加在主键上
```SQL
select normal from key_demo where normal=15 for update;
```
```BASH
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
| ENGINE | ENGINE_LOCK_ID                           | ENGINE_TRANSACTION_ID | THREAD_ID | EVENT_ID | OBJECT_SCHEMA   | OBJECT_NAME | PARTITION_NAME | SUBPARTITION_NAME | INDEX_NAME | OBJECT_INSTANCE_BEGIN | LOCK_TYPE | LOCK_MODE | LOCK_STATUS | LOCK_DATA              |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
| INNODB | 140046389701848:2163:140046401327824     |                 36367 |        49 |       25 | mysql_lock_demo | key_demo    | NULL           | NULL              | NULL       |       140046401327824 | TABLE     | IX        | GRANTED     | NULL                   |
| INNODB | 140046389701848:1098:4:1:140046401324832 |                 36367 |        49 |       25 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140046401324832 | RECORD    | X         | GRANTED     | supremum pseudo-record |
| INNODB | 140046389701848:1098:4:2:140046401324832 |                 36367 |        49 |       25 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140046401324832 | RECORD    | X         | GRANTED     | 5                      |
| INNODB | 140046389701848:1098:4:3:140046401324832 |                 36367 |        49 |       25 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140046401324832 | RECORD    | X         | GRANTED     | 0                      |
| INNODB | 140046389701848:1098:4:4:140046401324832 |                 36367 |        49 |       25 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140046401324832 | RECORD    | X         | GRANTED     | 10                     |
| INNODB | 140046389701848:1098:4:5:140046401324832 |                 36367 |        49 |       25 | mysql_lock_demo | key_demo    | NULL           | NULL              | PRIMARY    |       140046401324832 | RECORD    | X         | GRANTED     | 15                     |
+--------+------------------------------------------+-----------------------+-----------+----------+-----------------+-------------+----------------+-------------------+------------+-----------------------+-----------+-----------+-------------+------------------------+
```


## 总结

1.主键为查询条件
    
    1.1 等值查询,查询结果存在
        1.1.1 查询不回表
            1.1.1.1 for share  对主键加记录锁
            1.1.1.2 for update 对主键加记录锁
    1.2 等值查询,查询结果不存在
        1.2.1 查询不回表
            1.2.1.1 for share  对下一条记录的主键加间隙锁
            1.2.1.2 for update 对下一条记录的主键加间隙锁
    1.3 范围查询,查询结果存在
        1.3.1 查询不回表
            1.3.1.1 for share  复杂,查看案例
            1.3.1.2 for update 复杂,查看案例
    1.4 范围查询,查询结果不存在
        1.4.1 查询不回表
            1.4.1.1 for share  对下一条记录的主键加间隙锁
            1.4.1.2 for update 对下一条记录的主键加间隙锁

2.唯一索引为查询条件
    
    1.1 等值查询,查询结果存在
        1.1.1 查询回表
            1.1.1.1 for share
            1.1.1.2 for update
        1.1.2 查询不回表
            1.1.2.1 for share
            1.1.2.2 for update
    1.2 等值查询,查询结果不存在
        1.2.1 查询回表
            1.2.1.1 for share
            1.2.1.2 for update
        1.2.2 查询不回表
            1.2.2.1 for share
            1.2.2.2 for update
    1.3 范围查询,查询结果存在
        1.3.1 查询回表
            1.3.1.1 for share
            1.3.1.2 for update
        1.3.2 查询不回表
            1.3.2.1 for share
            1.3.2.2 for update
    1.4 范围查询,查询结果不存在
        1.4.1 查询回表
            1.4.1.1 for share
            1.4.1.2 for update
        1.4.2 查询不回表
            1.4.2.1 for share
            1.4.2.2 for update

3.普通索引为查询条件
    
    1.1 等值查询,查询结果存在
        1.1.1 查询回表
            1.1.1.1 for share
            1.1.1.2 for update
        1.1.2 查询不回表
            1.1.2.1 for share
            1.1.2.2 for update
    1.2 等值查询,查询结果不存在
        1.2.1 查询回表
            1.2.1.1 for share
            1.2.1.2 for update
        1.2.2 查询不回表
            1.2.2.1 for share
            1.2.2.2 for update
    1.3 范围查询,查询结果存在
        1.3.1 查询回表
            1.3.1.1 for share
            1.3.1.2 for update
        1.3.2 查询不回表
            1.3.2.1 for share
            1.3.2.2 for update
    1.4 范围查询,查询结果不存在
        1.4.1 查询回表
            1.4.1.1 for share
            1.4.1.2 for update
        1.4.2 查询不回表
            1.4.2.1 for share
            1.4.2.2 for update